<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Distributed System on Junyi's Lab</title><link>https://www.junyi.dev/tags/distributed-system/</link><description>Junyi's Lab (Distributed System)</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><lastBuildDate>Tue, 12 Sep 2023 15:15:37 +0800</lastBuildDate><atom:link href="https://www.junyi.dev/tags/distributed-system/index.xml" rel="self" type="application/rss+xml"/><item><title>Distributed System: Primary Backup Replication</title><link>https://www.junyi.dev/posts/paxos-review-3/</link><pubDate>Tue, 12 Sep 2023 15:15:37 +0800</pubDate><guid>https://www.junyi.dev/posts/paxos-review-3/</guid><description>&lt;p>å¼€èƒƒèœæ¥äº†ï¼&lt;/p>
&lt;p>ä½ æœ‰ä¸€ä¸ªç¡¬ç›˜ï¼Œå­˜äº†å¾ˆå¤šé‡è¦èµ„æ–™ï¼Œä½ æ‹…å¿ƒè¿™ä¸ªç¡¬ç›˜æŸå¤©åäº†ï¼Œæ€Žä¹ˆåŠžï¼Ÿ&lt;/p>
&lt;p>å½“ç„¶æ˜¯å¤šä¹°ç‚¹ç¡¬ç›˜ï¼ŒæŠŠæ•°æ®å¤‡ä»½åœ¨ä¸åŒçš„ç¡¬ç›˜ä¸Šã€‚&lt;/p>
&lt;p>ä¿è¯å¯é ï¼Œå°±æ˜¯é€šè¿‡å¤šä¸ªä¸€è‡´çš„æ•°æ®å‰¯æœ¬æ¥å®žçŽ°çš„ã€‚&lt;/p>
&lt;hr>
&lt;h2 id="å‰æå‡è®¾" >
&lt;div>
&lt;a href="#%e5%89%8d%e6%8f%90%e5%81%87%e8%ae%be">
#
&lt;/a>
å‰æå‡è®¾
&lt;/div>
&lt;/h2>&lt;p>æˆ‘ä»¬å‡è®¾æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯&lt;ruby>ç¡®å®š&lt;rt>deterministic&lt;/rt>&lt;/ruby>çš„&lt;/p>
&lt;!--
å¤šçº¿ç¨‹é‚£æ ·ï¼Œå› ä¸º scheduler çš„åŽŸå› å¯¼è‡´æ¯æ¬¡æ‰§è¡Œçš„ç»“æžœéƒ½ä¸ä¸€æ ·ã€‚ -->
&lt;h2 id="æœ€ç®€å•çš„-primary--backup" >
&lt;div>
&lt;a href="#%e6%9c%80%e7%ae%80%e5%8d%95%e7%9a%84-primary--backup">
#
&lt;/a>
æœ€ç®€å•çš„ primary &amp;amp; backup
&lt;/div>
&lt;/h2>&lt;ol>
&lt;li>client&lt;strong>s&lt;/strong> å‘é€ operation (Put, Get, Append) åˆ° primary-server&lt;/li>
&lt;li>primary-server å†³å®š operation çš„æ‰§è¡Œé¡ºåº&lt;/li>
&lt;li>primary-server æŠŠ operation çš„æ‰§è¡Œé¡ºåºå‘é€ç»™ backup-server&lt;/li>
&lt;li>backup-server æŒ‰ç…§ primary-server å‘é€çš„é¡ºåºæ‰§è¡Œ operation ï¼ˆhot-standbyï¼‰
&lt;ul>
&lt;li>æˆ–è€… backup-server æŒ‰ç…§ primary-server å‘é€çš„é¡ºåºè®°å½• operation ä½†ä¸æ‰§è¡Œï¼ˆcold-standbyï¼‰&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ç­‰ backup-server æˆåŠŸç»“æŸï¼Œprimary-server ç»™ client å‘å›žå¤&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>é—®é¢˜æ˜¯ï¼Œæ€Žä¹ˆå†³å®šè°æ¥å½“ primary-serverï¼Ÿ&lt;/strong>&lt;/p>
&lt;p>&lt;strong>æ€Žä¹ˆå†³å®šè°æ¥å½“ backup-serverï¼Ÿ&lt;/strong>&lt;/p>
&lt;p>&lt;strong>client æ€Žä¹ˆçŸ¥é“è°æ˜¯ primary-serverï¼Ÿ&lt;/strong>&lt;/p>
&lt;p>&lt;strong>ç­”æ¡ˆï¼š&lt;/strong> &lt;span class="spoiler">å¼•å…¥ä¸€å° view-serverï¼Œè®©è¿™ä¸ª view-server æ¥åšå†³å®šï¼Œå¹¶ä¸” client åŽ»é—® view-server è°æ˜¯ primary-serverã€‚ä¸ºä»€ä¹ˆå«å®ƒ view-server ï¼Ÿ å› ä¸ºè¿™æ¶‰åŠåˆ°ä¸€ä¸ªé‡è¦æ¦‚å¿µã€Œviewã€ï¼ŒåŽé¢ä¼šè®²åˆ°ï¼Œåˆ«ç€æ€¥ï¼&lt;/span>&lt;/p>
&lt;p>çŸ¥é“äº†ç­”æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·è®¾è®¡æ•´ä¸ªç³»ç»Ÿï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>æˆ‘ä»¬è®©æ¯å°æœåŠ¡å™¨å‘é€å¿ƒè·³ç»™ view-serverï¼Œå‘Šè¯‰ view-server è‡ªå·±è¿˜æ´»ç€ã€‚&lt;/p>
&lt;p>é—®ï¼šæœ‰æ²¡æœ‰å¯èƒ½è‡ªå·±æ´»ç€ä½†æ˜¯ view-server è®¤ä¸ºè‡ªå·±æ­»äº†ï¼Ÿ&lt;span class="spoiler"> æœ‰å¯èƒ½å› ä¸ºç½‘ç»œé—®é¢˜ï¼Œå¿ƒè·³æ²¡å‘å‡ºåŽ»ï¼Œ view-server è®¤ä¸ºèŠ‚ç‚¹æŒ‚äº†ï¼Œä½†å…¶å®žèŠ‚ç‚¹è¿˜æ´»ç€&lt;/span>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æˆ‘ä»¬ promote idle-server æˆä¸º backup-serverï¼Œä½†ä¸è¶Šçº§ promote æˆä¸º primary-server&lt;/p>
&lt;p>é—®ï¼šé™¤éžæœ‰ç§æƒ…å†µï¼Ÿ&lt;span class="spoiler">ç³»ç»Ÿåˆšå¯åŠ¨æ—¶ï¼ˆå…¨éƒ½æ˜¯ idle-serverã€éœ€è¦ä¸€ä¸ª primary çš„æ—¶å€™ï¼‰&lt;/span>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åªæœ‰ backup-server ä¼šè¢« promote æˆ primary-server&lt;/p>
&lt;/li>
&lt;/ul>
&lt;figure>
&lt;img src="view-service.png" alt="View Service" width="500" />
&lt;figcaption>Fig.1 - One View Server and Two Nodes&lt;/figcaption>
&lt;/figure>
&lt;h2 id="ä»€ä¹ˆæ˜¯-view-server-é‡Œçš„-view" >
&lt;div>
&lt;a href="#%e4%bb%80%e4%b9%88%e6%98%af-view-server-%e9%87%8c%e7%9a%84-view">
#
&lt;/a>
ä»€ä¹ˆæ˜¯ view-server é‡Œçš„ view
&lt;/div>
&lt;/h2>&lt;p>ä¸€ä¸ª view æ˜¯ä¸€ä¸ª primary-server å’Œä¸€ä¸ª backup-server çš„é›†åˆï¼Œæè¿°äº†å½“å‰çŠ¶æ€&lt;strong>è°æ˜¯ primary è°æ˜¯ backup&lt;/strong>ã€‚&lt;/p>
&lt;p>æ³¨æ„ï¼Œä¸€ä¸ª view é‡Œï¼Œåªæœ‰ä¸€ä¸ª primary å’Œä¸€ä¸ª backupï¼Œå…¶å®ƒçš„ server æ ‡è®°ä¸º idleã€‚ï¼ˆæƒ³æƒ³çœ‹ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿï¼‰&lt;/p>
&lt;p>view ç”± view-server è¿›è¡Œç®¡ç†ï¼Œå…¶ä»–èŠ‚ç‚¹å¯ä»¥èŽ·å–åˆ°å½“å‰ç³»ç»Ÿçš„ viewã€‚&lt;/p>
&lt;figure>
&lt;img src="view.png" alt="view-service" width="400" />
&lt;figcaption>Fig.2 - Example of three different views, denotes three different states of the system&lt;/figcaption>
&lt;/figure>
&lt;p>&lt;strong>çœ‹äº†ä¸Šé¢çš„æè¿°ï¼Œæ„Ÿè§‰è‡ªå·±åˆè¡Œäº†ï¼ŒäºŽæ˜¯æˆ‘è®¾è®¡å‡ºäº†ä¸‹é¢çš„æµç¨‹&lt;/strong>&lt;/p>
&lt;blockquote>
&lt;p>ç³»ç»Ÿåˆšå¼€å§‹ï¼ŒæŒ‘ä¸€ä¸ª primary-serverï¼Œç„¶åŽæŒ‘ä¸€ä¸ª backup-serverï¼Œå…¶å®ƒçš„éƒ½æ˜¯ idle-serverï¼Œç„¶åŽå¼€å§‹å·¥ä½œã€‚&lt;/p>
&lt;p>primary ç«‹é©¬è®© backup æˆä¸ºæ–°çš„ primaryï¼Œä»Ž idle é‡Œé¢æŒ‘ä¸€ä¸ªæˆä¸º backupï¼Œç„¶åŽè®©è¿™ä¸ªæ–°çš„ primary æŠŠçŠ¶æ€éƒ½å‘é€ç»™ backup&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>å¾ˆç®€å•å˜›ï¼è¿™èƒ½æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ&lt;/strong>&lt;/p>
&lt;p>è¯éŸ³åˆšè½ï¼Œé—®é¢˜å°±æ¥äº†ã€‚&lt;/p>
&lt;p>è¯·çœ‹ä¸‹é¢è¿™ä¸ªæƒ…å†µï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-markdown" data-lang="markdown">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">`View 1, primary=A, backup=B;`&lt;/span> è¿™æ—¶å€™ A æŒ‚äº†ï¼ŒB æˆä¸º primaryï¼Œä»Ž idle é‡Œé¢æŒ‘ä¸€ä¸ª C æˆä¸º backupï¼Œç„¶åŽ B å‘é€çŠ¶æ€ç»™ Cã€‚
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">`View 2, primary=B, backup=C;`&lt;/span> B å‘çŠ¶æ€çš„æ—¶å€™æŒ‚äº†ï¼ŒC æˆä¸º primaryï¼Œidle é‡Œé¢æ²¡æœºå™¨äº†
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">`View 3, primary=C, backup=_;`&lt;/span> Cï¼šðŸ˜…ï¼Ÿï¼ˆæ­¤æ—¶ C æ ¹æœ¬ä¸çŸ¥é“ç³»ç»Ÿçš„çŠ¶æ€æ˜¯ä»€ä¹ˆï¼‰
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰€ä»¥æˆ‘ä»¬åˆšåˆšå¯¹æ•´ä¸ªç³»ç»Ÿçš„æè¿°ï¼Œæ˜¯æœ‰ç¼ºé™·çš„ã€‚&lt;/p>
&lt;p>æ€Žä¹ˆæ”¹å‘¢ï¼Œæˆ‘ä»¬è®© view-server å¿…é¡»ç­‰å¾… primary-server &lt;ruby>ç¡®è®¤&lt;rt>ACK&lt;/rt>&lt;/ruby> å½“å‰çš„ viewã€‚&lt;/p>
&lt;p>å°±ç®— primary-server æŒ‚äº†ï¼Œview-server ä¹Ÿè¦ç­‰ ACKã€‚&lt;/p>
&lt;p>ï¼ˆç›´è§‰å‘Šè¯‰æˆ‘ä»¬ï¼Œè¿™ç§ç­‰å¾… ACK çš„è¡Œä¸ºå¯èƒ½å¯¼è‡´ç³»ç»Ÿå¡ä½ï¼‰&lt;/p>
&lt;h2 id="æ€»ç»“ä¸€ä¸‹æ‰€æœ‰çš„è§„åˆ™" >
&lt;div>
&lt;a href="#%e6%80%bb%e7%bb%93%e4%b8%80%e4%b8%8b%e6%89%80%e6%9c%89%e7%9a%84%e8%a7%84%e5%88%99">
#
&lt;/a>
æ€»ç»“ä¸€ä¸‹æ‰€æœ‰çš„è§„åˆ™
&lt;/div>
&lt;/h2>&lt;ol>
&lt;li>
&lt;p>åœ¨ view i+1 çš„ primary å¿…é¡»æ˜¯ view i çš„ backup&lt;/p>
&lt;p>å¦‚æžœæ²¡æœ‰è¿™ä¸ªè§„åˆ™ä¼šæ€Žæ ·ï¼Ÿ&lt;span class="spoiler">&lt;strong>Split brain:&lt;/strong> primary A, backup B, but can&amp;rsquo;t reach view-server. C,D are promoted to primary and backup, C doesn&amp;rsquo;t know previous state.&lt;/span>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>primary å¿…é¡»ç­‰ backup æ‰§è¡Œå®Œï¼Œæ‰å¯ä»¥å›žå¤ client&lt;/p>
&lt;p>å¦‚æžœæ²¡æœ‰è¿™ä¸ªè§„åˆ™ä¼šæ€Žæ ·ï¼Ÿ&lt;span class="spoiler">&lt;strong>Missing write:&lt;/strong> client writes to Aï¼ŒA crashes before writing to B, clients read from B&lt;/span>&lt;/p>
&lt;p>ä¸€å®šè¦è½¬å‘ read() ç»™ backup å—ï¼Ÿï¼ˆè¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„ä¼˜åŒ–æ“ä½œï¼‰&lt;span class="spoiler">å¿…é¡»è½¬å‘ã€‚ä¸ç„¶å¯èƒ½å‡ºçŽ° &lt;strong>Stale read&lt;/strong>: at &lt;em>view 1&lt;/em>, A,B are primary and backup, but A cannot reach view-server. now &lt;em>view 2&lt;/em>, B,C are primary backup. client 1 writes to B, client 2 reads from A. A returns outdated data ï¼ˆä¸è¿‡ stale read ä¾ç„¶ç¬¦åˆ sequential consistencyï¼‰&lt;/span>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¦‚æžœ view æ˜¯æ­£ç¡®çš„ï¼Œbackup å¿…é¡»æŽ¥å—&lt;ruby>è½¬å‘çš„è¯·æ±‚&lt;rt>Forwarded Request&lt;/rt>&lt;/ruby>ï¼Œå¹¶ä¸”æ‰§è¡Œ&lt;/p>
&lt;p>å¦‚æžœæ²¡æœ‰è¿™ä¸ªè§„åˆ™ä¼šæ€Žæ ·ï¼Ÿ&lt;span class="spoiler">&lt;strong>Partially Split Brain&lt;/strong>&lt;/span>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>non-primary èŠ‚ç‚¹&lt;strong>å¿…é¡»æ‹’ç»&lt;/strong> client çš„è¯·æ±‚&lt;/p>
&lt;p>å¦‚æžœæ²¡æœ‰è¿™ä¸ªè§„åˆ™ä¼šæ€Žæ ·ï¼Ÿ&lt;span class="spoiler">&lt;strong>Inconsistencies:&lt;/strong> client&amp;rsquo;s view may outdated, send request to old primary server.&lt;/span>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>state-transfer çš„æ—¶å€™ä¸èƒ½æœ‰æ“ä½œã€‚ï¼ˆAtomic State Transferï¼‰&lt;/p>
&lt;p>å¦‚æžœæ²¡æœ‰è¿™ä¸ªè§„åˆ™ä¼šæ€Žæ ·ï¼Ÿ&lt;span class="spoiler">&lt;/span>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="è„‘è£‚-split-brain" >
&lt;div>
&lt;a href="#%e8%84%91%e8%a3%82-split-brain">
#
&lt;/a>
è„‘è£‚ (Split-brain)
&lt;/div>
&lt;/h2>&lt;p>è¿™ä¸ªè¯æœ‰ç‚¹å“äººã€‚ã€‚ã€‚å…¶å®žæ˜¯åœ¨è¯´ï¼š&lt;strong>åœ¨ç½‘ç»œæ•…éšœæ—¶ï¼Œä¸¤ä¸ªåŠä»¥ä¸Šçš„èŠ‚ç‚¹éƒ½è®¤ä¸ºè‡ªå·±æ˜¯ Leader (primary-server)ã€‚&lt;/strong>&lt;/p>
&lt;blockquote>
&lt;p>View 1, primary=A, backup=B; è¿™æ—¶å€™ A ç½‘ç»œå‡ºæ•…éšœæ— æ³•è¿žæŽ¥åˆ° view-serverï¼ŒB æˆä¸ºæ–°çš„ primaryã€‚
View 2, primary=B, backup=_; B æ˜¯ æ–°çš„ primaryï¼Œä½† A ä¹Ÿè®¤ä¸ºè‡ªå·±æ˜¯ primary&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨æˆ‘ä»¬ä¹‹å‰çš„è§„å®šé‡Œï¼Œåªæœ‰ primary-server ä¼šå›žå¤ clientï¼Œä½†æ˜¯è„‘è£‚çš„æ—¶å€™ï¼Œä¸¤ä¸ªèŠ‚ç‚¹éƒ½ä¼šå›žå¤ clientï¼Œè¿™å°±å¯èƒ½å¯¼è‡´ client æ”¶åˆ°çš„æ•°æ®ä¸ä¸€è‡´ã€‚
ï¼ˆç ´åäº† Linearzabilityï¼‰&lt;/p>
&lt;h2 id="ç³»ç»Ÿå¡ä½" >
&lt;div>
&lt;a href="#%e7%b3%bb%e7%bb%9f%e5%8d%a1%e4%bd%8f">
#
&lt;/a>
ç³»ç»Ÿå¡ä½
&lt;/div>
&lt;/h2>&lt;p>æœ‰å“ªäº›å¯èƒ½å¯¼è‡´ç³»ç»Ÿå¡ä½ï¼ˆå¤„ç†ä¸äº† client çš„è¯·æ±‚ï¼‰çš„æƒ…å†µï¼Ÿ&lt;/p>
&lt;ol>
&lt;li>view-server æŒ‚äº†&lt;/li>
&lt;li>æ•´ä¸ªç½‘ç»œæŒ‚äº†&lt;/li>
&lt;li>client åªèƒ½ç»ƒåˆ° view-serverï¼Œä¸èƒ½è¿žæŽ¥åˆ° primary-server&lt;/li>
&lt;li>backup server æ²¡æœ‰äº†ï¼ˆå› ä¸º primary è½¬ç§»çŠ¶æ€ç»™ backupï¼Œè½¬ç§»å®Œäº†å›žå¤ view-server ä¸€ä¸ª ACKï¼‰&lt;/li>
&lt;li>çŠ¶æ€è½¬ç§»ä¹‹å‰ primary æŒ‚äº†&lt;/li>
&lt;/ol>
&lt;h2 id="é‡å¤å†™å…¥" >
&lt;div>
&lt;a href="#%e9%87%8d%e5%a4%8d%e5%86%99%e5%85%a5">
#
&lt;/a>
é‡å¤å†™å…¥
&lt;/div>
&lt;/h2>&lt;h2 id="ä¸ºä»€ä¹ˆ-primary-backup-æ¯”è¾ƒéš¾" >
&lt;div>
&lt;a href="#%e4%b8%ba%e4%bb%80%e4%b9%88-primary-backup-%e6%af%94%e8%be%83%e9%9a%be">
#
&lt;/a>
ä¸ºä»€ä¹ˆ Primary Backup æ¯”è¾ƒéš¾
&lt;/div>
&lt;/h2>&lt;ul>
&lt;li>primary å¯èƒ½æŒ‚æŽ‰&lt;/li>
&lt;li>backup å¯èƒ½æŒ‚æŽ‰&lt;/li>
&lt;li>é€šè®¯å¯èƒ½ ä¸´æ—¶/æ°¸ä¹… æŒ‚æŽ‰&lt;/li>
&lt;li>å‚ä¸Žè€…çš„å†³ç­–å¯èƒ½å­˜åœ¨å»¶è¿Ÿï¼š
&lt;ul>
&lt;li>view server ä¸çŸ¥é“ primary æŒ‚äº†&lt;/li>
&lt;li>primary æŒ‚äº†å—ï¼ŸæŒ‚äº†ä¹‹åŽæ¢å¤ï¼Œè¿˜éœ€è¦å›žå¤ client å—ï¼Ÿ&lt;/li>
&lt;li>backup æŒ‚äº†å—ï¼Ÿstate transfer ç»“æŸäº†å—ï¼Ÿ&lt;/li>
&lt;li>client ä¸çŸ¥é“ view æœ‰æ²¡æœ‰åˆ‡æ¢&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="æ€»ç»“ä¸€ä¸‹-view-server-çš„ç¼ºç‚¹" >
&lt;div>
&lt;a href="#%e6%80%bb%e7%bb%93%e4%b8%80%e4%b8%8b-view-server-%e7%9a%84%e7%bc%ba%e7%82%b9">
#
&lt;/a>
æ€»ç»“ä¸€ä¸‹ view-server çš„ç¼ºç‚¹
&lt;/div>
&lt;/h2>&lt;ol>
&lt;li>view-server è‡ªå·±å­˜åœ¨å•ç‚¹æ•…éšœé—®é¢˜&lt;/li>
&lt;li>view-server å¿…é¡»ç­‰å¾… primary çš„ ackï¼Œå³ä½¿ primary å¯èƒ½æŒ‚äº†ä¹Ÿè¦ç­‰&lt;/li>
&lt;/ol>
&lt;h2 id="rubyçŠ¶æ€æœºå¤åˆ¶rtstate-machine-replicationrtruby" >
&lt;div>
&lt;a href="#ruby%e7%8a%b6%e6%80%81%e6%9c%ba%e5%a4%8d%e5%88%b6rtstate-machine-replicationrtruby">
#
&lt;/a>
&lt;ruby>çŠ¶æ€æœºå¤åˆ¶&lt;rt>State Machine Replication&lt;/rt>&lt;/ruby>
&lt;/div>
&lt;/h2>&lt;blockquote>
&lt;p>&lt;strong>çŠ¶æ€æœºæœ‰ä¸€ä¸ªç‰¹æ€§ï¼š&lt;/strong> ä»»ä½•åˆå§‹çŠ¶æ€ä¸€æ ·çš„çŠ¶æ€æœºï¼Œå¦‚æžœæ‰§è¡Œçš„å‘½ä»¤åºåˆ—ä¸€æ ·ï¼Œåˆ™æœ€ç»ˆè¾¾åˆ°çš„çŠ¶æ€ä¹Ÿä¸€æ ·ã€‚&lt;/p>
&lt;p>å¦‚æžœå°†æ­¤ç‰¹æ€§åº”ç”¨åœ¨å¤šå‚ä¸Žè€…è¿›è¡Œåå•†å…±è¯†ä¸Šï¼Œå¯ä»¥ç†è§£ä¸ºç³»ç»Ÿä¸­å­˜åœ¨å¤šä¸ªå…·æœ‰å®Œå…¨ç›¸åŒçš„çŠ¶æ€æœºï¼ˆå‚ä¸Žè€…ï¼‰ï¼Œè¿™äº›çŠ¶æ€æœºèƒ½æœ€ç»ˆä¿æŒä¸€è‡´çš„å…³é”®å°±æ˜¯èµ·å§‹çŠ¶æ€å®Œå…¨ä¸€è‡´å’Œæ‰§è¡Œå‘½ä»¤åºåˆ—å®Œå…¨ä¸€è‡´ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ ¹æ®çŠ¶æ€æœºçš„ç‰¹æ€§ï¼Œè¦è®©å¤šå°æœºå™¨çš„æœ€ç»ˆçŠ¶æ€ä¸€è‡´ï¼Œåªè¦ç¡®ä¿å®ƒä»¬çš„åˆå§‹çŠ¶æ€æ˜¯ä¸€è‡´çš„ï¼Œå¹¶ä¸”æŽ¥æ”¶åˆ°çš„æ“ä½œæŒ‡ä»¤åºåˆ—ä¹Ÿæ˜¯ä¸€è‡´çš„å³å¯ï¼Œæ— è®ºè¿™ä¸ªæ“ä½œæŒ‡ä»¤æ˜¯æ–°å¢žã€ä¿®æ”¹ã€åˆ é™¤æŠ‘æˆ–æ˜¯å…¶ä»–ä»»ä½•å¯èƒ½çš„ç¨‹åºè¡Œä¸ºï¼Œéƒ½å¯ä»¥ç†è§£ä¸ºè¦å°†ä¸€è¿žä¸²çš„æ“ä½œæ—¥å¿—æ­£ç¡®åœ°å¹¿æ’­ç»™å„ä¸ªåˆ†å¸ƒå¼èŠ‚ç‚¹ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¹¶ä¸è¦æ±‚æ‰€æœ‰èŠ‚ç‚¹çš„æ¯ä¸€æ¡æŒ‡ä»¤éƒ½æ˜¯åŒæ—¶å¼€å§‹ã€åŒæ­¥å®Œæˆçš„ï¼Œåªè¦æ±‚åœ¨æ­¤æœŸé—´çš„å†…éƒ¨çŠ¶æ€ä¸èƒ½è¢«å¤–éƒ¨è§‚å¯Ÿåˆ°ï¼Œä¸”å½“æ“ä½œæŒ‡ä»¤åºåˆ—æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹çš„æœ€ç»ˆçš„çŠ¶æ€æ˜¯ä¸€è‡´çš„ï¼Œè¿™ç§æ¨¡åž‹å°±è¢«ç§°ä¸ºçŠ¶æ€æœºå¤åˆ¶ï¼ˆState Machine Replicationï¼‰ã€‚&lt;/p>
&lt;style>
.spoiler {
visibility: hidden;
}
.spoiler::before {
visibility: visible;
content: "hover me to see the answer";
color: white;
background-color: black;
}
.spoiler:hover {
visibility: visible;
}
.spoiler:hover::before {
display: none;
}
&lt;/style></description></item><item><title>Distributed System: Consistency</title><link>https://www.junyi.dev/posts/paxos-review-2/</link><pubDate>Tue, 12 Sep 2023 14:06:01 +0800</pubDate><guid>https://www.junyi.dev/posts/paxos-review-2/</guid><description>&lt;p>è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„&lt;ruby>ä¸€è‡´æ€§&lt;rt>Consistency&lt;/rt>&lt;/ruby>è¿›è¡ŒåŒºåˆ†&lt;/p>
&lt;p>&lt;strong>&lt;ruby>å¼±ä¸€è‡´æ€§&lt;rt>Weak Consistency&lt;/rt>&lt;/ruby>&lt;/strong>ï¼šå…è®¸ç³»ç»Ÿçš„è¡Œä¸ºä¸Žå•ä¸€ç³»ç»Ÿçš„è¡Œä¸ºä¸ä¸€è‡´ã€‚&lt;/p>
&lt;p>&lt;strong>&lt;ruby>å¼ºä¸€è‡´æ€§&lt;rt>Strong Consistency&lt;/rt>&lt;/ruby>&lt;/strong>ï¼šæ•´ä¸ªç³»ç»Ÿè¡¨çŽ°å¾—åƒæ˜¯ä¸€ä¸ªå•ä¸€çš„ã€æ— å¹¶å‘çš„å®žä½“ã€‚&lt;/p>
&lt;hr>
&lt;p>ä¸‹é¢çš„ä¸€è‡´æ€§ï¼Œç”±å¼±åˆ°å¼º&lt;/p>
&lt;h2 id="rubyæœ€ç»ˆä¸€è‡´æ€§rteventual-consistencyrtruby" >
&lt;div>
&lt;a href="#ruby%e6%9c%80%e7%bb%88%e4%b8%80%e8%87%b4%e6%80%a7rteventual-consistencyrtruby">
#
&lt;/a>
&lt;ruby>æœ€ç»ˆä¸€è‡´æ€§&lt;rt>Eventual Consistency&lt;/rt>&lt;/ruby>
&lt;/div>
&lt;/h2>&lt;p>ç³»ç»Ÿæœ€ç»ˆä¼šè¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€ã€‚&lt;/p>
&lt;h2 id="rubyå› æžœä¸€è‡´æ€§rtcausal-consistencyrtruby" >
&lt;div>
&lt;a href="#ruby%e5%9b%a0%e6%9e%9c%e4%b8%80%e8%87%b4%e6%80%a7rtcausal-consistencyrtruby">
#
&lt;/a>
&lt;ruby>å› æžœä¸€è‡´æ€§&lt;rt>Causal Consistency&lt;/rt>&lt;/ruby>
&lt;/div>
&lt;/h2>&lt;p>æ¯” Sequential Consistency æ›´å¼±ã€‚
å¦‚æžœæ“ä½œ A ä¾èµ–äºŽæ“ä½œ Bï¼Œé‚£ä¹ˆæ“ä½œ B å‘ç”Ÿåœ¨æ“ä½œ A ä¹‹å‰ï¼Œä½†æ˜¯å¦‚æžœæ“ä½œ A å’Œæ“ä½œ B ä¹‹é—´æ²¡æœ‰å› æžœå…³ç³»ï¼Œé‚£ä¹ˆæ“ä½œ A å’Œæ“ä½œ B çš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æœ‰å› æ‰æœ‰æžœï¼Œå› åœ¨æžœä¹‹å‰&lt;/p>
&lt;p>å…ˆçœ‹è§å› ï¼Œå†çœ‹è§æžœ&lt;/p>
&lt;p>å¦‚æžœä¸€ä¸ªé—®é¢˜è¢«å›žç­”ï¼Œæ˜¾ç„¶é—®é¢˜æœ¬èº«å¾—å…ˆåœ¨é‚£é‡Œï¼Œå› ä¸ºç»™å‡ºç­”æ¡ˆçš„äººå¿…é¡»å·²ç»çœ‹åˆ°è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è®¤ä¸ºåœ¨é—®é¢˜å’Œç­”æ¡ˆä¹‹é—´å­˜åœ¨å› æžœä¾èµ–ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ¯”å¦‚å¾®ä¿¡æœ‹å‹åœˆéœ€è¦æœåŠ¡å™¨ä¹‹é—´é‡‡ç”¨å› æžœä¸€è‡´æ€§ï¼Œæ¥ä¿è¯ç”¨æˆ·åˆ·æœ‹å‹åœˆæ—¶ä¸ä¼šçœ‹åˆ°è¯„è®ºæ‰€å¯¹åº”çš„ç­”å¤è€Œçœ‹ä¸åˆ°å¯¹åº”çš„è¯„è®ºã€‚&lt;/p>
&lt;img src="wechat-arch.png" alt="drawing" width="600" />
&lt;p>å»¶ä¼¸é˜…è¯»ï¼šæ€Žä¹ˆç”Ÿæˆå”¯ä¸€ä¸”é€’å¢žçš„ IDï¼Ÿ&lt;a href="https://www.infoq.cn/article/wechat-serial-number-generator-architecture/">å¾®ä¿¡åºåˆ—å·ç”Ÿæˆå™¨æž¶æž„è®¾è®¡åŠæ¼”å˜&lt;/a>&lt;a href="https://segmentfault.com/a/1190000040964518">é›ªèŠ±ç®—æ³•&lt;/a>&lt;/p>
&lt;h2 id="rubyåºåˆ—ä¸€è‡´æ€§rtsequential-consistencyrtruby" >
&lt;div>
&lt;a href="#ruby%e5%ba%8f%e5%88%97%e4%b8%80%e8%87%b4%e6%80%a7rtsequential-consistencyrtruby">
#
&lt;/a>
&lt;ruby>åºåˆ—ä¸€è‡´æ€§&lt;rt>Sequential Consistency&lt;/rt>&lt;/ruby>
&lt;/div>
&lt;/h2>&lt;p>ä¸ç®¡ç³»ç»Ÿæ€Žä¹ˆè¿è¡Œï¼Œå¾—åˆ°çš„ç»“æžœå°±å¥½åƒæŠŠæ‰€æœ‰èŠ‚ç‚¹çš„æ‰€æœ‰æ“ä½œæŒ‰ç…§æŸä¸ª sequential order æŽ’åºåŽè¿è¡Œï¼Œä½†æ˜¯åœ¨è¿™ä¸ª sequential order ä¸­ï¼Œæ¥è‡ªåŒä¸€ä¸ªèŠ‚ç‚¹çš„æ“ä½œä»ç„¶ä¿æŒç€å®ƒä»¬åœ¨èŠ‚ç‚¹ä¸­è¢«æŒ‡å®šçš„é¡ºåºã€‚&lt;/p>
&lt;p>æ¢å¥è¯è¯´ï¼Œç‰©ç†æ„ä¹‰ä¸Šçš„æ—¶é—´ï¼Œä¸èƒ½å†³å®š&lt;ruby>æ“ä½œ&lt;rt>operations&lt;/rt>&lt;/ruby>çš„æ‰§è¡Œé¡ºåº&lt;/p>
&lt;p>ç”¨ä½œ Transaction æ—¶æˆ‘ä»¬ç§°ä¹‹ä¸º Serializability&lt;/p>
&lt;p>å¸¸ç”¨åœ¨ é“¶è¡Œã€é‡‘èžæ•°æ®åº“ã€äº‹åŠ¡&lt;/p>
&lt;h2 id="rubyçº¿æ€§ä¸€è‡´æ€§rtlinearizable-consistencyrtruby" >
&lt;div>
&lt;a href="#ruby%e7%ba%bf%e6%80%a7%e4%b8%80%e8%87%b4%e6%80%a7rtlinearizable-consistencyrtruby">
#
&lt;/a>
&lt;ruby>çº¿æ€§ä¸€è‡´æ€§&lt;rt>Linearizable Consistency&lt;/rt>&lt;/ruby>
&lt;/div>
&lt;/h2>&lt;p>ä¹Ÿå« Linearizability&lt;/p>
&lt;p>æ˜¯ã€é¡ºåºä¸€è‡´æ€§ + æŒ‰ç…§ç‰©ç†æ—¶é—´é¡ºåºæ‰§è¡Œã€‘ã€‚&lt;/p>
&lt;p>æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§çš„æ•°æ®ç»“æž„ï¼Œè¡¨çŽ°å¾—åƒæ˜¯ä¸€ä¸ªå•ä¸€çš„ã€æ— å¹¶å‘çš„å®žä½“ã€‚&lt;span style="color: #cd7a32;">&lt;strong>æ˜¯æœ€å¼ºçš„ä¿è¯&lt;/strong>&lt;/span>&lt;/p>
&lt;p>æ¯”å¦‚ Google Spanner&lt;/p>
&lt;hr>
&lt;p>ä»‹ç»åˆ°è¿™é‡Œï¼ŒåŸºæœ¬ä¸Šå¯¹ Consistency æœ‰äº†å¤§è‡´çš„äº†è§£ï¼ŒæŽ¥ä¸‹æ¥å¯ä»¥çœ‹ Primary Backup Replication äº†ã€‚&lt;/p>
&lt;h2 id="lab-2" >
&lt;div>
&lt;a href="#lab-2">
#
&lt;/a>
Lab 2
&lt;/div>
&lt;/h2>&lt;p>å®žçŽ° Primary-backup replicationï¼š&lt;/p>
&lt;ol>
&lt;li>client å‘é€è¯·æ±‚ç»™ primary-server&lt;/li>
&lt;li>ç”±ä¸€ä¸ª ä¸­å¤® view-server å†³å®šè°æ˜¯ primary è°æ˜¯ backup&lt;/li>
&lt;li>primary æŒ‚äº†ï¼Œbackup é¡¶ä¸Šæ¥&lt;/li>
&lt;/ol>
&lt;img src="pbr.png" alt="drawing" width="400"/></description></item><item><title>Distributed System: Ordering of events</title><link>https://www.junyi.dev/posts/paxos-review-1/</link><pubDate>Tue, 12 Sep 2023 11:32:04 +0800</pubDate><guid>https://www.junyi.dev/posts/paxos-review-1/</guid><description>&lt;p>ä¸Šä¸ªå­¦æœŸçš„ &lt;a href="https://nusmods.com/courses/CS5223/distributed-systems">CS5223 Distributed Systems&lt;/a> ï¼ŒProf. Li Jialin è®²çš„è›®å¥½ï¼Œè™½ç„¶æˆ‘å®žçŽ°äº† Basic Paxos å’Œ Multi Paxosï¼ˆæ²¡å®žçŽ°åˆ†å¸ƒå¼äº‹åŠ¡ï¼‰ï¼Œä½†æ˜¯è€ä¸ä½æ—¶é—´çš„æ‹·æ‰“ï¼Œå†™çš„ Paxos éƒ½å¿«å¿˜å…‰äº†&amp;hellip;&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œèµ¶ç´§å¼€ä¸€ç¯‡åšå®¢ï¼ŒæŠŠæˆ‘çš„æƒ³æ³•éƒ½è®°å½•ä¸‹æ¥ï¼Œä»¥ä¾¿&lt;strong>ä¹‹åŽçš„å¤ä¹ &lt;/strong>ã€‚&lt;/p>
&lt;hr>
&lt;p>é¦–å…ˆç®€å•è¿‡ä¸€ä¸‹è¿™äº›åŸºç¡€æ¦‚å¿µ&lt;/p>
&lt;h2 id="happens-before-relationship" >
&lt;div>
&lt;a href="#happens-before-relationship">
#
&lt;/a>
Happens-before relationship
&lt;/div>
&lt;/h2>&lt;ul>
&lt;li>
&lt;p>Within a process, A comes before B then Aâ†’B, it also means&lt;/p>
&lt;blockquote>
&lt;p>B &lt;strong>could&lt;/strong> have been influenced by A&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>If a â†’ b, then b !â†’ a&lt;/p>
&lt;blockquote>
&lt;p>What about a!â†’b, does that mean bâ†’a? &lt;span style="color: white">&lt;strong>NO&lt;/strong>&lt;/span>&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>If a â†’ b, and b â†’ c, then a â†’ c (transitivity)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>a !â†’ b and b !â†’ a, means a and b are &lt;strong>concurrent&lt;/strong>&lt;/p>
&lt;blockquote>
&lt;p>no one can tell whether a or b happened first!&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;/ul>
&lt;h2 id="lamport-clock" >
&lt;div>
&lt;a href="#lamport-clock">
#
&lt;/a>
Lamport clock
&lt;/div>
&lt;/h2>&lt;img src="logical-clock.png" alt="drawing" width="400"/>
&lt;p>We can use clocks to implement a lock.&lt;/p>
&lt;p>&lt;strong>Our goals are:&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>Only one process can hold the lock at a time.&lt;/li>
&lt;li>Grant the lock &lt;strong>in request order&lt;/strong>.&lt;/li>
&lt;li>Requesting processes &lt;strong>eventually&lt;/strong> get the lock.&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>Our assumptions are:&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>&lt;strong>In order&lt;/strong> point-to-point message delivery.&lt;/li>
&lt;li>&lt;strong>No failures&lt;/strong>.&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>Implementation:&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>Each message carries a timestamp $T_m$&lt;/li>
&lt;li>Three message types:
&lt;ul>
&lt;li>request&lt;/li>
&lt;li>release&lt;/li>
&lt;li>acknowledge&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Each node&amp;rsquo;s state:
&lt;ul>
&lt;li>A queue of requested messaged, ordered by $T_m$.&lt;/li>
&lt;li>The latest timestamp it received from each node.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>On receiving&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>receiving a request
&lt;ul>
&lt;li>record the timestamp&lt;/li>
&lt;li>add the request to the queue&lt;/li>
&lt;li>send an acknowledge&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>receiving a release
&lt;ul>
&lt;li>record the timestamp&lt;/li>
&lt;li>remove the request from the queue&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>receiving an acknowledge
&lt;ul>
&lt;li>record the timestamp&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>To perform&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>To acquire a lock
&lt;ul>
&lt;li>send request to every node, including itself&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>To release a lock
&lt;ul>
&lt;li>send release to every node, including itself&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>The lock is acquired when&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>My request is at the head of the queue.&lt;/li>
&lt;li>I&amp;rsquo;ve received higher timestamp &lt;strong>from every node&lt;/strong>.&lt;/li>
&lt;li>So my request must be the earliest.&lt;/li>
&lt;/ol>
&lt;h2 id="vector-clock" >
&lt;div>
&lt;a href="#vector-clock">
#
&lt;/a>
Vector clock
&lt;/div>
&lt;/h2>&lt;p>Clock is a vector C, length = # of nodes.&lt;/p>
&lt;blockquote>
&lt;p>(0, 0, 0) for a 3-node system&lt;/p>
&lt;/blockquote>
&lt;p>On node i, increment C[i] on each event.&lt;/p>
&lt;blockquote>
&lt;p>node 0 (3,5,2), after event: (4,5,2)&lt;/p>
&lt;/blockquote>
&lt;p>On node i, received a message, increment C[i], and take the max of each element.&lt;/p>
&lt;blockquote>
&lt;p>node 0 (4,5,2), received message (2,7,0): (4,7,2)&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>If Cx[i] &amp;lt; Cy[i] and Cx[j] &amp;gt; Cy[j] for some i, j&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>Cx and Cy are concurrent&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>if Cx[i] &amp;lt;= Cy[i] for all i, and there exist j such that Cx[j] &amp;lt; Cy[j]&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>Cx happens before Cy&lt;/li>
&lt;/ul>
&lt;img src="vector-lock.jpg" width="400" alt="vector-lock" />
&lt;h2 id="lab-1" >
&lt;div>
&lt;a href="#lab-1">
#
&lt;/a>
Lab 1
&lt;/div>
&lt;/h2>&lt;p>å®žçŽ°ä¸€ä¸ª at-most-once çš„ KV Store&lt;/p>
&lt;ul>
&lt;li>RPC è¦ä¹ˆæœ€å¤šæ‰§è¡Œä¸€æ¬¡ï¼Œè¦ä¹ˆä¸æ‰§è¡Œ&lt;/li>
&lt;/ul></description></item></channel></rss>