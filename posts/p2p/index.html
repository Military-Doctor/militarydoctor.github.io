<!doctype html><html lang=zh-cn data-theme><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>P2P 技术 - Junyi&rsquo;s Lab</title>
<meta name=description content="本文主要记录自己学习的 P2P 技术
在这篇文章里，主要区分了各种 NAT 的类型，包括全锥形、地址限制锥形、端口限制锥形的内容和区别"><link rel=icon type=image/x-icon href=https://www.junyi.dev/favicon.ico><link rel=apple-touch-icon-precomposed href=https://www.junyi.dev/favicon.png><style>body{visibility:hidden;opacity:0}</style><noscript><style>body{visibility:visible;opacity:1}</style></noscript><link rel=stylesheet href=/css/style.min.42c77dbe264b081b6f3745aedeb79de572b52fe570748653a57a0f103228f037.css integrity="sha256-Qsd9viZLCBtvN0Wu3red5XK1L+VwdIZTpXoPEDIo8Dc="><link rel=stylesheet href=/css/style.min.c4c04b3ef88e3d619ad4c7ee5e03048422bc55c4fefdc1f07657c1133670aa22.css integrity="sha256-xMBLPviOPWGa1MfuXgMEhCK8VcT+/cHwdlfBEzZwqiI="><link rel=stylesheet href=/css/style.min.21c5d8fe0a79d623b0adc1ce4bd4f6dd2c05cd939c9aaaa966ba7186b1464f4d.css integrity="sha256-IcXY/gp51iOwrcHOS9T23SwFzZOcmqqpZrpxhrFGT00="><script src=/js/script.min.08f04d96386c73c9bf4d160333f8f448c05a6e01c06770542ee0e013954ce930.js type=text/javascript integrity="sha256-CPBNljhsc8m/TRYDM/j0SMBabgHAZ3BULuDgE5VM6TA="></script><script async defer data-website-id=dd99a470-c29d-4882-8c6a-89f1cec9045c data-cache=false data-do-not-track=false src=https://analytics.eu.umami.is/script.js></script></head><body><a class=skip-main href=#main>跳至内容</a><div class=container><header class=common-header><div class=header-top><div class=header-top-left><h1 class="site-title noselect"><a href=/>Junyi's Lab</a></h1><div class=theme-switcher><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-sun-high"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14.828 14.828A4 4 0 109.172 9.172a4 4 0 005.656 5.656z"/><path d="M6.343 17.657l-1.414 1.414"/><path d="M6.343 6.343 4.929 4.929"/><path d="M17.657 6.343l1.414-1.414"/><path d="M17.657 17.657l1.414 1.414"/><path d="M4 12H2"/><path d="M12 4V2"/><path d="M20 12h2"/><path d="M12 20v2"/></svg></span></div><script>const STORAGE_KEY="user-color-scheme",defaultTheme="auto";let currentTheme,switchButton,autoDefinedScheme=window.matchMedia("(prefers-color-scheme: dark)");function switchTheme(){currentTheme=currentTheme==="dark"?"light":"dark",localStorage&&localStorage.setItem(STORAGE_KEY,currentTheme),document.documentElement.setAttribute("data-theme",currentTheme),changeGiscusTheme(currentTheme),document.body.dispatchEvent(new CustomEvent(currentTheme+"-theme-set"))}const autoChangeScheme=e=>{currentTheme=e.matches?"dark":"light",document.documentElement.setAttribute("data-theme",currentTheme),changeGiscusTheme(currentTheme),document.body.dispatchEvent(new CustomEvent(currentTheme+"-theme-set"))};document.addEventListener("DOMContentLoaded",function(){switchButton=document.querySelector(".theme-switcher"),currentTheme=detectCurrentScheme(),currentTheme==="auto"?(autoChangeScheme(autoDefinedScheme),autoDefinedScheme.addListener(autoChangeScheme)):document.documentElement.setAttribute("data-theme",currentTheme),switchButton&&switchButton.addEventListener("click",switchTheme,!1),showContent()});function detectCurrentScheme(){return localStorage!==null&&localStorage.getItem(STORAGE_KEY)?localStorage.getItem(STORAGE_KEY):defaultTheme?defaultTheme:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function showContent(){document.body.style.visibility="visible",document.body.style.opacity=1}function changeGiscusTheme(e){function t(e){const t=document.querySelector("iframe.giscus-frame");if(!t)return;t.contentWindow.postMessage({giscus:e},"https://giscus.app")}t({setConfig:{theme:e}})}</script><ul class="social-icons noselect"><li><a href=https://github.com/Junyi-99 title=Github rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-github"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></span></a></li><li><a href=https://www.linkedin.com/in/junyi-hou-00b668248/ title=Linkedin rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-linkedin"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4m0 2a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2z"/><path d="M8 11v5"/><path d="M8 8v.01"/><path d="M12 16v-5"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></span></a></li><li><a href=/index.xml title=RSS rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-rss"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 19m-1 0a1 1 0 102 0 1 1 0 10-2 0"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></span></a></li></ul></div><div class=header-top-right></div></div><nav class=noselect><a href=https://www.junyi.dev/ title>HOME</a>
<a href=https://www.junyi.dev/gallery/ title>GALLERY</a>
<a href=https://www.junyi.dev/tags/ title>TAGS</a>
<a href=https://www.junyi.dev/posts/ title>ARCHIVE</a>
<a href=https://www.junyi.dev/about/ title>ABOUT</a></nav></header><main id=main tabindex=-1><article class="post h-entry"><div class=post-header><header><h1 class="p-name post-title">P2P 技术</h1></header><div class="post-info noselect"><div class="post-date dt-published"><time datetime=2020-06-26>June 26, 2020</time></div><a class="post-hidden-url u-url" href=/posts/p2p/>/posts/p2p/</a>
<a href=https://www.junyi.dev/ class="p-name p-author post-hidden-author h-card" rel=me>Junyi Hou</a><div class=post-taxonomies><ul class=post-tags><li><a href=/tags/p2p/>#P2P</a></li><li><a href>#技术文章</a></li></ul></div></div></div><details class="toc noselect"><summary>Table of Contents</summary><div class=inner><nav id=TableOfContents><ul><li><a href=#网络地址转换-nat-network-address-translation>网络地址转换 NAT (Network Address Translation)</a><ul><li><a href=#基本网络地址转换-basic-nat>基本网络地址转换 Basic NAT</a></li><li><a href=#网络地址端口转换-napt>网络地址端口转换 NAPT</a></li></ul></li><li><a href=#锥形-nat>锥形 NAT</a></li><li><a href=#全锥形-nat-full-cone-nat>全锥形 NAT (Full Cone NAT)</a></li><li><a href=#地址限制锥形-nat-address-restricted-cone-nat>地址限制锥形 NAT (Address Restricted Cone NAT)</a></li><li><a href=#端口限制锥形-nat-port-restricted-cone-nat>端口限制锥形 NAT (Port Restricted Cone NAT)</a></li><li><a href=#对称形-natsymmetric-nat>对称形 NAT（Symmetric NAT）</a></li><li><a href=#symmetric-和-port-restricted-的区别>Symmetric 和 Port Restricted 的区别</a></li><li><a href=#references>References</a></li></ul></nav></div></details><script>var toc=document.querySelector(".toc");toc&&toc.addEventListener("click",function(){event.target.tagName!=="A"&&(event.preventDefault(),this.open?(this.open=!1,this.classList.remove("expanded")):(this.open=!0,this.classList.add("expanded")))})</script><div class="content e-content"><p>本文主要记录自己学习的 P2P 技术</p><p>在这篇文章里，主要区分了各种 NAT 的类型，包括全锥形、地址限制锥形、端口限制锥形的内容和区别</p><h2 id=网络地址转换-nat-network-address-translation><div><a href=#%e7%bd%91%e7%bb%9c%e5%9c%b0%e5%9d%80%e8%bd%ac%e6%8d%a2-nat-network-address-translation>#
</a>网络地址转换 NAT (Network Address Translation)</div></h2><h3 id=基本网络地址转换-basic-nat><div><a href=#%e5%9f%ba%e6%9c%ac%e7%bd%91%e7%bb%9c%e5%9c%b0%e5%9d%80%e8%bd%ac%e6%8d%a2-basic-nat>##
</a>基本网络地址转换 Basic NAT</div></h3><p>简单来讲，就是直接把内部 IP 翻译成外部 IP，这种转换技术受限于对外地址的数量，是 IP 到 IP 的转换（端口不换）</p><p>需要了解的名词有：</p><ul><li>SNAT：源地址转换</li><li>DNAT：目标地址转换</li></ul><p>以只有一个对外地址举例，如果 ClientA 和 ClientB 同时访问同一个 Web Server，那么当 NAT Gatway 收到这个 Web Server 响应包的时候，就无法判断将数据包转发给哪台客户机。</p><p>于是就有了我们接下来要介绍的 NAPT 技术</p><h3 id=网络地址端口转换-napt><div><a href=#%e7%bd%91%e7%bb%9c%e5%9c%b0%e5%9d%80%e7%ab%af%e5%8f%a3%e8%bd%ac%e6%8d%a2-napt>##
</a>网络地址端口转换 NAPT</div></h3><p>先明确几个概念：</p><p>内网主机拥有的网络地址：<code>(LocalIP:LocalPort)</code></p><p>经由 NAT 转换后的网络地址：<code>(PublicIP:PublicPort)</code></p><p>外网主机拥有的网络地址：<code>(RemoteIP:RemotePort)</code></p><p>对<code>源端口</code>和<code>目标端口</code>同时进行转换。这样就可以让<code>一个公网IP</code>满足<code>多个后端主机</code>同时访问外部网络。比如家庭宽带。</p><p>这项技术最为常见，它检测并修改出入数据包的<strong>IP 地址</strong>和<strong>端口号</strong>，从而允许多个内网主机共享同一个公网 IP 地址</p><p>NAT 分为 <code>锥形NAT</code> 和 <code>对称型NAT</code></p><h2 id=锥形-nat><div><a href=#%e9%94%a5%e5%bd%a2-nat>#
</a>锥形 NAT</div></h2><p><strong>同一个内部主机的地址和端口，无论目的地址是否相同，NAT 都将它转换成同一个外部地址和端口。</strong></p><p>192.168.1.2:8000 访问 Baidu.com:80 和 google.com:80 时，经由 NAT 转换，内部的 192.168.1.2:8000 都会被转化成 1.2.3.4:5000，baidu 看到的是 5000 端口，谷歌看到的也是</p><p>192.168.1.2:<strong>8001</strong> 访问 baidu.com:80 和 google.com:80 时，经由 NAT 转换，内部的 192.168.1.2:8001 都会变成 1.2.3.4:<strong>5001</strong>，baidu 看到的是 <strong>5001</strong> 端口，google 看到的也是。</p><p>懂了吗，这就是锥形的由来</p><h2 id=全锥形-nat-full-cone-nat><div><a href=#%e5%85%a8%e9%94%a5%e5%bd%a2-nat-full-cone-nat>#
</a>全锥形 NAT (Full Cone NAT)</div></h2><p>内向外：<code>(特定本地IP:特定本地端口)</code> –> <code>(固定映射IP:固定映射端口)</code> –> <code>(特定远端IP:特定远端端口)</code></p><p>建立 Full Cone NAT 转换后</p><p>外向内：<code>(特定本地IP:特定本地端口)</code> &lt;– <code>(固定映射IP:固定映射端口)</code> &lt;– <code>(任意远端IP:任意端口)</code></p><p>当内部主机向外发送请求时，NAT 网关会打开一个端口创建一个公网映射，形成一个 IP 端口元组，然后会将传入这个端口的数据全部转发给内部主机。<strong>一旦映射建立，那么任意一台主机，只要给映射出来的公网 IP 和端口发送数据，就可以直接到达后端服务</strong>：</p><p>也就是，内部主机以相同的 <code>(LocalIP:LocalPort)</code> 对 2 个不同的 <code>(RemoteIP:RemotePort)</code> 发送 UDP 报文时，NAT 会为内部主机只分配一个 <code>(PublicIP:PublicPort)</code>，<strong>任意一台主机都可以给 <code>(PublicIP:PublicPort)</code> 发送数据</strong>。</p><h2 id=地址限制锥形-nat-address-restricted-cone-nat><div><a href=#%e5%9c%b0%e5%9d%80%e9%99%90%e5%88%b6%e9%94%a5%e5%bd%a2-nat-address-restricted-cone-nat>#
</a>地址限制锥形 NAT (Address Restricted Cone NAT)</div></h2><p>远端 IP 地址受限，远端端口无所谓</p><p>内向外：<code>(特定本地IP:特定本地端口)</code> –> <code>(固定映射IP:固定映射端口)</code> –> <code>(特定远端IP:特定远端端口)</code></p><p>建立 Address Restricted Cone NAT 转换后</p><p>外向内：<code>(特定本地IP:特定本地端口)</code> &lt;– <code>(固定映射IP:固定映射端口)</code> &lt;– <code>(特定远端IP:任意端口)</code></p><p>（注意这里变成了 <strong>任意</strong>端口）</p><p>我更喜欢它的英文形式，中文翻译的很不恰当。英文叫<strong>地址受限的锥形 NAT</strong>。当内部主机向外发送请求时，NAT 网关会打开一个端口创建一个公网映射，<strong>同时记录外网的 IP 地址</strong>。一旦映射建立，<strong>只有被记录的 IP 地址给映射出来的公网 IP 和端口发送数据，才可以到达后端服务，其他 IP 地址发送给 NAT 网关的，将会被丢弃。</strong></p><p>也就是，内部主机以相同的 (LocalIP:LocalPort) 对 2 个不同的 (RemoteIP:RemotePort) 发送 UDP 报文时，NAT 会为内部主机只分配一个 <code>(PublicIP:PublicPort)</code>，同时，也只有这 2 个 RemoteIP 可以给 (PublicIP: PublicPort) 发送数据（因为先由内向外发过），这两个 RemoteIP 的 RemotePort 可以是任意的</p><h2 id=端口限制锥形-nat-port-restricted-cone-nat><div><a href=#%e7%ab%af%e5%8f%a3%e9%99%90%e5%88%b6%e9%94%a5%e5%bd%a2-nat-port-restricted-cone-nat>#
</a>端口限制锥形 NAT (Port Restricted Cone NAT)</div></h2><p>远端 IP 地址和端口都受限，且只有内部主机向外发送过消息才可以建立。</p><p>一旦内部地址（iAddr:iPort）映射到外部地址（eAddr:ePort），所有发自 iAddr:iPort 的数据包都经由 eAddr:ePort 向外发送。</p><p>内向外：(特定本地 IP:特定本地端口) –>(固定映射 IP:固定映射端口) –> (特定远端 IP:特定远端端口)</p><p>建立 Port Restricted Cone NAT 转换后</p><p>外向内：(特定本地 IP:特定本地端口) &lt;– (固定映射 IP:固定映射端口) &lt;– (特定远端 IP:特定端口)</p><p>（注意这里变成了 <strong>特定</strong>端口）</p><p>这种模式同时记录<strong>内部主机的 IP 和端口</strong>和<strong>外部主机的 IP 和端口</strong>，也就是形成了一种绑定关系。</p><p>与 Address Restricted Cone NAT 的区别是，Address Restricted Cone NAT 记录的只有外网主机的 IP，不记录端口，那个外网主机的随便一个端口给内网主机发送数据都可以。</p><p>Port Restricted Cone NAT 是记录外网主机的 IP 和端口，<strong>只有 (内网 IP, 内网端口) 和 (外网 IP, 外网端口) 这两个条件同时满足，数据才会转发给内网主机</strong>。而且以后给外部任何主机发送数据，都会用之前转换的 <code>(PublicIP:PublicPort)</code> 给外部主机发送数据。</p><p>也就是，内部主机以相同的 (LocalIP:LocalPort) 对 2 个不同的 (RemoteIP:RemotePort) 发送 UDP 报文时，NAT 会为内部主机只分配一个 <code>(PublicIP:PublicPort)</code>，同时，也只有这 2 个 (RemoteIP:ReportPort) 可以给 (PublicIP: PublicPort) 发送数据（因为先由内向外发过）</p><h2 id=对称形-natsymmetric-nat><div><a href=#%e5%af%b9%e7%a7%b0%e5%bd%a2-natsymmetric-nat>#
</a>对称形 NAT（Symmetric NAT）</div></h2><p>连接不同的外部目标，NAT 打开的端口不同。是一种「一对一映射关系」。</p><p>换句话讲，不同的 (iAddr:port, eAddr:port) 组合，NAT 网关会产生不同的链路。</p><p>看起来也就是对称的了。（本地地址：端口，目标地址：端口）</p><p>比如 <strong>localA</strong>:8000 经过一台拥有 <strong>global</strong> 的一台对称 NAT 的 Gateway，访问 <strong>baidu</strong>:80 和 <strong>google</strong>:80，</p><p>baidu 看到的可能是来自 <strong>global</strong>:5003 的请求，google 看到的可能是来自 <strong>global</strong>:5010 的请求。</p><p>打个比方，当内部主机以相同的 (LocalIP:LocalPort) 对 2 个不同的 (RemoteIP:RemotePort) 发送 UDP 报文时，此时 NAT 将会为内部主机分配<strong>两个不同的</strong> <code>(PublicIP:PublicPort)</code>，并且建立起<strong>两个不同的内、外部 Tuple 转换关系</strong>。</p><h2 id=symmetric-和-port-restricted-的区别><div><a href=#symmetric-%e5%92%8c-port-restricted-%e7%9a%84%e5%8c%ba%e5%88%ab>#
</a>Symmetric 和 Port Restricted 的区别</div></h2><p><strong>Port Restricted:</strong>
<img src=port-restricted.png alt=drawing width=400></p><ul><li>一旦内部地址（iAddr:iPort）映射到外部地址（eAddr:ePort），所有发自 iAddr:iPort 的数据包都经由 eAddr:ePort 向外发送。</li></ul><p><strong>Symmetric:</strong>
<img src=symmetric.png alt=drawing width=400></p><ul><li>每一个来自相同内部 IP 与端口，到一个特定目的地 IP 和端口的请求，都映射到一个独特的外部 IP 和端口。</li></ul><h2 id=references><div><a href=#references>#
</a>References</div></h2><p><a href=https://evilpan.com/2015/10/31/p2p-over-middle-box/>[1] P2P 通信原理与实现</a></p><p><a href=https://zhuanlan.zhihu.com/p/136794983>[2] 网络之 NAT 和 N2N VPN</a></p><p><a href=https://www.cnblogs.com/my_life/articles/11018457.html>[3] NAT 的四种类型及类型检测 2【很好】</a></p><p><a href=https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2>[4] 网络地址转换 - Wikipedia</a></p></div></article><script>function detectCurrentScheme2(){const e="auto";return localStorage!==null&&localStorage.getItem("user-color-scheme")?localStorage.getItem("user-color-scheme"):e==="dark"||e==="light"?e:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}let giscusTheme=detectCurrentScheme2(),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"Junyi-99/Junyi-99.github.io","data-repo-id":"MDEwOlJlcG9zaXRvcnkzNDI4ODI3NzY=","data-category":"Announcements","data-category-id":"DIC_kwDOFG_52M4CZZZF","data-mapping":"url","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",lazyload:"false",async:!0},main=document.querySelector("main"),giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([e,t])=>giscusScript.setAttribute(e,t)),main.appendChild(giscusScript)</script></main><footer class="common-footer noselect"><ul class=language-select><li>Simplified Chinese</li><li><a href=/en/>English</a></li></ul><div class=common-footer-bottom><div style=display:flex;align-items:center;gap:8px>© Junyi Hou, 2024
<a aria-label="Check statistics data" style=display:flex;align-items:center;border-bottom:none;cursor:pointer;color:var(--pagination-link-color) href=https://eu.umami.is/share/2uUOpgCbx28B16Ro/www.junyi.dev><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-report-analytics"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 5H7A2 2 0 005 7v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><path d="M9 3m0 2a2 2 0 012-2h2a2 2 0 012 2v0a2 2 0 01-2 2h-2A2 2 0 019 5z"/><path d="M9 17v-5"/><path d="M12 17v-1"/><path d="M15 17v-3"/></svg></a></div><div>Powered by <a target=_blank rel="noopener noreferrer" href=https://gohugo.io/>Hugo</a>, theme <a target=_blank rel="noopener noreferrer" href=https://github.com/Junyi-99/hugo-theme-anubis2>Anubis2</a>.<br></div></div><p class="h-card vcard"><a href=https://www.junyi.dev/ class="p-name u-url url fn" rel=me>Junyi Hou</a>
/
<a class="p-email u-email email" rel=me href=mailto:junyi.h@comp.nus.edu.sg>junyi.h@comp.nus.edu.sg</a></p></footer></div></body></html>